<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Interactive Showcase - Masters</title>
        <link rel="stylesheet" href="../../css/styles.css" />
        <link rel="stylesheet" href="../../css/showcase.css" />
    </head>
    <body>
        <header>
            <button id="sidebar-toggle" aria-label="Toggle Navigation">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </button>
            <h1>Masters</h1>
        </header>
        <div class="container">
            <nav id="sidebar">
                <ul>
                    <li><a href="../../index.html">Home</a></li>
                    <li><a href="Sprint_1_Report.html">Sprint 1 Report</a></li>
                    <li>
                        <a href="Interactive_Showcase.html"
                            ><strong>Interactive Showcase</strong></a
                        >
                    </li>
                    <li>
                        <a href="Architecture-Stack.html">Architecture Stack</a>
                    </li>
                    <li>
                        <a href="Funding_Proposal.html">Funding Proposal</a>
                    </li>
                    <li><a href="how_to_use.html">How To Use</a></li>
                    <li><a href="Model.html">Model</a></li>
                    <li><a href="README.html">README (Docs)</a></li>
                    <li><a href="../CHANGELOG.html">CHANGELOG</a></li>
                    <li><a href="../MEMORY.html">MEMORY</a></li>
                    <li><a href="../README.html">README (Root)</a></li>
                </ul>
            </nav>

            <main>
                <div align="center">
                    <h1>Interactive Showcase</h1>
                    <p>
                        Test the dynamic Bayesian Risk Inference pipeline live.
                    </p>
                </div>

                <div class="showcase-container">
                    <div class="input-section">
                        <div class="input-api">
                            <label for="server-url">Backend API Server:</label>
                            <input
                                type="text"
                                id="server-url"
                                value="http://127.0.0.1:8000"
                                class="input-api-text"
                            />
                        </div>
                        <label for="policy-input"
                            ><strong
                                >Enter a synthetic Privacy Policy
                                clause:</strong
                            ></label
                        >
                        <textarea
                            id="policy-input"
                            placeholder="e.g., 'We collect your geolocation data endlessly without direct consent and keep it forever.'"
                        ></textarea>

                        <div class="upload-container">
                            <label for="policy-file"
                                ><strong
                                    >Or upload a full document (.txt or
                                    .pdf):</strong
                                ></label
                            >
                            <input
                                type="file"
                                id="policy-file"
                                accept=".txt,.pdf"
                                class="file-upload-input"
                            />
                        </div>
                        <button class="analyze-btn" id="analyze-btn">
                            Analyze Privacy Risks
                        </button>
                        <div id="status" class="status-msg"></div>
                    </div>

                    <div class="dashboard" id="dashboard">
                        <div class="panel full-width">
                            <h3>Compliance Evaluation Results</h3>
                            <h4 id="status-container"></h4>
                            <p class="panel-subtitle">
                                Total Flags Detected:
                                <span id="flags-container">0</span>
                            </p>
                        </div>

                        <div class="panel full-width">
                            <h3>Audit Trail</h3>
                            <p class="panel-subtitle">
                                Token-level Salience and Control Mappings
                            </p>
                            <div id="audit-trail-container"></div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- API Hookup Script -->
        <script>
            document
                .getElementById("analyze-btn")
                .addEventListener("click", async () => {
                    const text = document.getElementById("policy-input").value;
                    const fileInput = document.getElementById("policy-file");
                    const file = fileInput.files[0];
                    const baseUrl = document
                        .getElementById("server-url")
                        .value.replace(/\/$/, "");
                    const statusDiv = document.getElementById("status");
                    const dashboard = document.getElementById("dashboard");

                    if (!text.trim() && !file) {
                        statusDiv.textContent =
                            "Please enter text or upload a document to analyze.";
                        return;
                    }

                    statusDiv.textContent = `Calling Glassbox Backend at ${baseUrl}... (This may take a moment for large documents)`;

                    try {
                        let response;
                        if (file) {
                            const formData = new FormData();
                            formData.append("file", file);
                            response = await fetch(`${baseUrl}/analyze/file`, {
                                method: "POST",
                                body: formData,
                            });
                        } else {
                            response = await fetch(`${baseUrl}/analyze`, {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ text: text }),
                            });
                        }

                        if (!response.ok) {
                            throw new Error(
                                `Server returned ${response.status}`,
                            );
                        }

                        const taskData = await response.json();
                        const taskId = taskData.task_id;

                        statusDiv.textContent = `Analysis in progress...`;

                        let data = null;
                        while (true) {
                            await new Promise((resolve) =>
                                setTimeout(resolve, 3000),
                            );
                            const statusResp = await fetch(
                                `${baseUrl}/analyze/status/${taskId}`,
                            );
                            if (!statusResp.ok)
                                throw new Error(
                                    `Polling failed: ${statusResp.status}`,
                                );

                            const statusJson = await statusResp.json();
                            if (statusJson.status === "completed") {
                                data = statusJson.result;
                                break;
                            } else if (statusJson.status === "processing") {
                                statusDiv.textContent = statusJson.message
                                    ? `[Status] ${statusJson.message}`
                                    : `Processing...`;
                                continue;
                            } else if (statusJson.status === "error") {
                                throw new Error(
                                    statusJson.error ||
                                        "Pipeline inference failed.",
                                );
                            }
                        }

                        statusDiv.textContent = "";

                        // Inject overall status
                        const statusEl =
                            document.getElementById("status-container");
                        statusEl.textContent = `Status: ${data.status}`;
                        statusEl.style.color =
                            data.total_flags > 0 ? "red" : "green";

                        document.getElementById("flags-container").textContent =
                            data.total_flags;

                        // Inject Audit Trail
                        const auditContainer = document.getElementById(
                            "audit-trail-container",
                        );
                        auditContainer.innerHTML = "";

                        if (data.audit_trail && data.audit_trail.length > 0) {
                            data.audit_trail.forEach((entry) => {
                                const heatmap = entry.cause_heatmap || [];
                                let tokensHtml = heatmap
                                    .map(
                                        (t) =>
                                            `<span class="salience-token token-${t.category}">${t.token}</span>`,
                                    )
                                    .join("");

                                const isCompliant = !entry.triggered_status;
                                const iconHtml = isCompliant
                                    ? `<span class="icon-tick">✅</span>`
                                    : `<span class="icon-cross">❌</span>`;
                                const borderClass = isCompliant
                                    ? "entry-compliant"
                                    : "entry-violating";

                                let statusLabel = "Passed";
                                if (!isCompliant) {
                                    const match = data.violated_controls.find(
                                        (v) => v.control === entry.control_name,
                                    );
                                    const conf = match ? match.confidence : 0;
                                    statusLabel = `Failed (Conf: ${(conf * 100).toFixed(1)}%)`;
                                }

                                auditContainer.innerHTML += `
                                    <details class="audit-entry ${borderClass}">
                                        <summary>${iconHtml} <span class="audit-control-name">${entry.control_name}</span> - ${statusLabel}</summary>
                                        <div style="margin-top: 15px;">
                                            <p><strong>Trigger Text:</strong><br/> <em>"${entry.triggered_text}"</em></p>
                                            <p><strong>NLI Agent Thought Process:</strong><br/> <em style="color: #a0aec0;">${entry.cnm_reason}</em></p>
                                            <p><strong>High Salience Tokens (Transformer Attention):</strong><br/> <div class="audit-chunk">${tokensHtml}</div></p>
                                        </div>
                                    </details>
                                `;
                            });
                        } else {
                            auditContainer.innerHTML =
                                "<p>No compliance evaluations logged.</p>";
                        }

                        dashboard.classList.add("active");
                    } catch (error) {
                        statusDiv.textContent = `Error connecting to backend API: Make sure you ran 'uvicorn api.showcase_server:app --reload' locally.`;
                        console.error(error);
                    }
                });
        </script>

        <!-- Sidebar Toggle Script -->
        <script>
            document.addEventListener("DOMContentLoaded", () => {
                const toggle = document.getElementById("sidebar-toggle");
                const sidebar = document.getElementById("sidebar");

                if (toggle && sidebar) {
                    toggle.addEventListener("click", () => {
                        sidebar.classList.toggle("active");
                    });

                    document.addEventListener("click", (e) => {
                        if (
                            window.innerWidth <= 768 &&
                            sidebar.classList.contains("active") &&
                            !sidebar.contains(e.target) &&
                            !toggle.contains(e.target)
                        ) {
                            sidebar.classList.remove("active");
                        }
                    });
                }
            });
        </script>
    </body>
</html>
